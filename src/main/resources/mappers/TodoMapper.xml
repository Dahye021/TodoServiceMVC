<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    <mapper namespace="com.ssg.todoservice.mapper.TodoMapper">

    <sql id="search">
        <where>
            <!-- keyword 있을 때만 LIKE 생성 -->
            <if test="keyword != null and keyword != '' and types != null and types.size > 0">
                <bind name="kw" value="'%' + keyword + '%'"/>
                <trim prefix="(" suffix=")" suffixOverrides="OR">
                    <foreach collection="types" item="type">
                        <choose>
                            <when test="type == 't'"> title LIKE #{kw} OR </when>
                            <when test="type == 'w'"> writer LIKE #{kw} OR </when>
                        </choose>
                    </foreach>
                </trim>
            </if>

            <if test="finished != null and finished">
                AND finished = TRUE
            </if>

            <if test="from != null and to != null">
                AND dueDate BETWEEN #{from} AND #{to}
            </if>
        </where>
    </sql>
        <select id="getTime" resultType="string">
            SELECT NOW()
        </select>

        <insert id="insert">
            insert into todo (title, dueDate, writer) values (#{title}, #{dueDate}, #{writer})
        </insert>

        <select id="selectAll" resultType="com.ssg.todoservice.domain.TodoVO">
            select * from todo order by tno desc limit #{skip}, #{size}
        </select>

        <select id="selectOne" resultType="com.ssg.todoservice.domain.TodoVO">
            select * from todo where tno =#{tno}
        </select>

        <delete id="delete">
            delete from todo where tno = #{tno}
        </delete>

        <update id="update">
            update todo set title = #{title}, dueDate = #{dueDate}, finished= #{finished} where tno =#{tno}
        </update>

        <select id="selectList" resultType="com.ssg.todoservice.domain.TodoVO">
            SELECT * FROM todo
            <include refid="search"/>
            ORDER BY tno DESC
            LIMIT #{skip, jdbcType=INTEGER}, #{size, jdbcType=INTEGER}
        </select>
    </mapper>